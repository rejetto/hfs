name: signpath-windows

on:
  workflow_dispatch:

jobs:
  build-sign:
    runs-on: windows-latest
    permissions:
      contents: read
    env:
      NODE_VERSION: '20'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build server and UIs
        run: |
          npm run build-server
          npm run build-frontend
          npm run build-admin

      - name: Prepare dist dependencies
        run: npm run dist-modules

      - name: Build Windows binary
        run: |
          cd dist
          npx pkg . --public -C gzip -t node${{ env.NODE_VERSION }}-win-x64
          npx resedit-cli --in hfs.exe --icon 1,../hfs.ico --out hfs.exe

      - name: Prepare unsigned artifact folder
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist/signpath | Out-Null
          Copy-Item dist/hfs.exe dist/signpath/hfs.exe -Force
          Copy-Item dist/plugins dist/signpath/plugins -Recurse -Force

      - name: Upload unsigned artifact
        id: upload_unsigned
        uses: actions/upload-artifact@v4
        with:
          name: hfs-windows-unsigned
          path: dist/signpath/**

      - name: Sign with SignPath
        uses: SignPath/github-action-submit-signing-request@v1
        with:
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          organization-id: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
          project-slug: hfs
          artifact-configuration-slug: hfs_win_zip
          signing-policy-slug: release-signing
          github-artifact-id: ${{ steps.upload_unsigned.outputs.artifact-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          output-artifact-directory: dist/signpath-output

      - name: Package signed artifact
        shell: pwsh
        run: |
          $outputDir = 'dist/signpath-output'
          $zip = Get-ChildItem -Path $outputDir -Filter *.zip -Recurse | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($zip) {
            Copy-Item $zip.FullName 'dist/hfs-windows-x64-signed.zip' -Force
            exit 0
          }
          $items = Get-ChildItem -Path $outputDir
          if (-not $items) {
            Write-Host 'No signed artifact files found. Listing dist contents for troubleshooting:'
            Get-ChildItem -Path dist -Recurse | Select-Object FullName
            throw 'No signed artifact files found after signing.'
          }
          Compress-Archive -Path "$outputDir/*" -DestinationPath 'dist/hfs-windows-x64-signed.zip' -Force

      - name: Upload signed package
        uses: actions/upload-artifact@v4
        with:
          name: hfs-windows-signed
          path: dist/hfs-windows-x64-signed.zip
